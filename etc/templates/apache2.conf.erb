<%
# Consolidated Apache configuration for E2
# HTTP only (ALB terminates SSL)

require 'json'
require 'net/http'
require 'uri'

# Fetch CloudFront IP ranges from AWS
# These are needed for mod_remoteip to trust X-Forwarded-For headers
cloudfront_ips = []
begin
  uri = URI.parse('https://ip-ranges.amazonaws.com/ip-ranges.json')
  response = Net::HTTP.get_response(uri)
  if response.code == '200'
    aws_ranges = JSON.parse(response.body)
    cloudfront_ips = aws_ranges['prefixes']
      .select { |p| p['service'] == 'CLOUDFRONT' }
      .map { |p| p['ip_prefix'] }
  end
rescue => e
  # If fetch fails, we'll just use the static list below
  STDERR.puts "Warning: Could not fetch CloudFront IPs: #{e.message}"
end

# Load Apache blocks configuration from source control
blocks_config = '/var/everything/etc/apache_blocks.json'
ip_blocks = ""

if File.exist?(blocks_config)
  blocks = JSON.parse(File.read(blocks_config))

  ip_blocks += "\t# Explicit IP address bans\n"
  if blocks['banned_ips']
    blocks['banned_ips'].each do |ip|
      ip_blocks += "\tSetEnvIf X-FORWARDED-FOR \"#{ip}\" denyip\n"
    end
  end

  ip_blocks += "\t# IP address block bans\n"
  if blocks['banned_ipblocks']
    blocks['banned_ipblocks'].each do |block|
      ip_blocks += "\tSetEnvIf X-FORWARDED-FOR ^#{block.gsub(".", "\\.")} denyip\n"
    end
  end

  ip_blocks += "\t# User agent bans\n"
  if blocks['banned_user_agents']
    blocks['banned_user_agents'].each do |ua|
      ua_quoted = ua.include?(' ') ? "\"#{ua}\"" : ua
      ip_blocks += "\tBrowserMatchNoCase #{ua_quoted} denyip\n"
    end
  end
else
  ip_blocks += "\t# WARNING: Apache blocks configuration not found at #{blocks_config}\n"
end

rotatelogs = '/usr/bin/rotatelogs'
%>
Mutex file:${APACHE_LOCK_DIR} default
PidFile ${APACHE_PID_FILE}

Timeout 300
KeepAlive On
MaxKeepAliveRequests 500
KeepAliveTimeout 15

User ${APACHE_RUN_USER}
Group ${APACHE_RUN_GROUP}

##### E2 CUSTOM SETTINGS #####
UseCanonicalName On
ServerTokens Prod
ServerSignature EMail
TraceEnable Off

# Fargate/Docker environment variables
PassEnv AWS_CONTAINER_CREDENTIALS_RELATIVE_URI
PassEnv AWS_DEFAULT_REGION
PassEnv E2_DOCKER
PassEnv E2_MAINTENANCE_MESSAGE
PassEnv E2_DBSERV

HostnameLookups Off
AccessFileName .htaccess
<Files ~ "^\.ht">
	Order allow,deny
	Deny from all
	Satisfy all
</Files>

<% if node["override_configuration"].eql? "development" %>
Define E2_DEVELOPMENT
UnDefine E2_PRODUCTION
PerlPassEnv NYTPROF
PerlModule Devel::NYTProf::Apache
<% else %>
Undefine E2_DEVELOPMENT
Define E2_PRODUCTION
<% end %>

# Include module configuration
Include mods-enabled/*.load
Include mods-enabled/*.conf

# mod_remoteip - Use X-Forwarded-For header as client IP
# Required for mod_evasive to rate-limit by real client IP (not ALB IP)
<IfModule mod_remoteip.c>
	RemoteIPHeader X-Forwarded-For
	# Trust private/internal IPs (ALB, Docker, localhost)
	RemoteIPTrustedProxy 10.0.0.0/8
	RemoteIPTrustedProxy 172.16.0.0/12
	RemoteIPTrustedProxy 192.168.0.0/16
	RemoteIPTrustedProxy 127.0.0.1
<% if cloudfront_ips.any? %>
	# CloudFront IP ranges (fetched from AWS at config generation time)
<% cloudfront_ips.each do |cidr| %>
	RemoteIPTrustedProxy <%= cidr %>
<% end %>
<% else %>
	# Fallback CloudFront ranges (if dynamic fetch failed)
	# These may become stale - prefer dynamic fetch
	RemoteIPTrustedProxy 120.52.22.96/27
	RemoteIPTrustedProxy 205.251.249.0/24
	RemoteIPTrustedProxy 180.163.57.128/26
	RemoteIPTrustedProxy 204.246.168.0/22
	RemoteIPTrustedProxy 18.160.0.0/15
	RemoteIPTrustedProxy 205.251.252.0/23
	RemoteIPTrustedProxy 54.192.0.0/16
	RemoteIPTrustedProxy 204.246.173.0/24
	RemoteIPTrustedProxy 54.230.200.0/21
	RemoteIPTrustedProxy 130.176.0.0/17
	RemoteIPTrustedProxy 108.156.0.0/14
	RemoteIPTrustedProxy 99.86.0.0/16
	RemoteIPTrustedProxy 13.32.0.0/15
	RemoteIPTrustedProxy 52.222.128.0/17
	RemoteIPTrustedProxy 54.230.0.0/17
	RemoteIPTrustedProxy 54.230.128.0/18
	RemoteIPTrustedProxy 64.252.64.0/18
	RemoteIPTrustedProxy 64.252.128.0/18
	RemoteIPTrustedProxy 99.84.0.0/16
	RemoteIPTrustedProxy 205.251.254.0/24
<% end %>
</IfModule>

# mod_evasive rate limiting configuration (production only)
# Protects against DoS attacks and aggressive scrapers
# Disabled in development to avoid rate limiting during testing
<IfDefine E2_PRODUCTION>
<IfModule mod_evasive20.c>
	# Hash table size for tracking IPs (larger = more memory, better performance)
	DOSHashTableSize 3097

	# Per-page limits disabled (set very high) - we only care about overall volume
	DOSPageCount 999
	DOSPageInterval 1

	# Site-wide request threshold: block if total requests exceed limit
	# WAF is 400 requests / 5 minutes = ~1.3/sec
	# Setting 50 requests / 10 seconds = 5/sec (allows bursts, catches scrapers)
	DOSSiteCount 50
	DOSSiteInterval 10

	# How long to block offending IPs (seconds)
	# Match WAF 5-minute evaluation window
	DOSBlockingPeriod 300

	# Log blocked requests locally
	DOSLogDir /var/log/apache2

	# Log blocked IPs to CloudWatch for monitoring
	# %s is replaced with the blocked IP address
	DOSSystemCommand "/var/everything/tools/log-rate-limit-block.sh %s"

	# Whitelist ALB health checks and internal IPs
	DOSWhitelist 127.0.0.1
	DOSWhitelist 10.*.*.*
	DOSWhitelist 172.16.*.*
	DOSWhitelist 192.168.*.*
</IfModule>
</IfDefine>

LogLevel warn
LogFormat "{\"time\":\"%{%Y-%m-%d}tT%{%T}t.%{msec_frac}tZ\",\"process\":\"%D\",\"filename\":\"%f\",\"remoteIP\":\"%{X-Forwarded-For}i\",\"host\":\"%V\",\"request\":\"%U\",\"query\":\"%q\",\"method\":\"%m\",\"status\":\"%>s\",\"userAgent\":\"%{User-agent}i\",\"referer\":\"%{Referer}i\"}" cloudwatch

BrowserMatch "^ELB-HealthChecker" loghealthcheck

<IfDefine E2_DEVELOPMENT>
ErrorLogFormat "{\"time\":\"%{%usec_frac}t\", \"function\" : \"[%-m:%l]\", \"process\" : \"[pid%P]\" ,\"message\" : \"%M\"}"
ErrorLog "|/usr/bin/rotatelogs -f /var/log/apache2/e2.error.%Y%m%d%H.log 3600"
SetEnvIf Remote_Addr "127\.0\.0\.1" dontlog
SetEnvIf Request_URI "^/server_live\.html$" dontlog
SetEnvIf Request_URI "favicon.ico$" dontlog
SetEnvIf Request_URI "^/robots\.txt$" dontlog
</IfDefine>

<IfDefine E2_PRODUCTION>
Define E2StartServers 10
Define E2MinSpareServers 10
Define E2MaxSpareServers 20
Define E2MaxRequestWorkers 30
Define E2MaxConnections 5000
</IfDefine>

<IfDefine E2_DEVELOPMENT>
Define E2StartServers 5
Define E2MinSpareServers 5
Define E2MaxSpareServers 10
Define E2MaxRequestWorkers 20
Define E2MaxConnections 0
</IfDefine>

<IfModule mpm_prefork_module>
StartServers         ${E2StartServers}
MinSpareServers      ${E2MinSpareServers}
MaxSpareServers      ${E2MaxSpareServers}
MaxRequestWorkers    ${E2MaxRequestWorkers}
MaxConnectionsPerChild ${E2MaxConnections}
</IfModule>

PerlSwitches -I/var/everything/ecore -I/var/libraries/lib/perl5
ServerName everything2.com
Listen 80
ListenBacklog 511

##### MAIN VIRTUALHOST (HTTP ONLY) #####
<VirtualHost _default_:80>
	ServerName everything2.com
	ServerAdmin e2webmaster@everything2.com
	DocumentRoot /var/everything/www

	<IfDefine PERLDB>
		<Perl>
			use Apache::DB ();
			Apache::DB->init;
		</Perl>
		<Location />
			PerlFixupHandler Apache::DB
		</Location>
	</IfDefine>

	<Perl>
		use CGI qw(-utf8);
	</Perl>

	<Directory />
		Options FollowSymLinks
		AllowOverride None
	</Directory>

	<IfDefine E2_PRODUCTION>
		# Limit process size to 800M in production (original value)
		# Reverted to isolate issues - use smem in Server Telemetry to monitor
		<Perl>
			use Apache2::SizeLimit;
			$Apache2::SizeLimit::MAX_PROCESS_SIZE = 800000;
			$Apache2::SizeLimit::CHECK_EVERY_N_REQUESTS = 20;
		</Perl>
		PerlCleanupHandler Apache2::SizeLimit
	</IfDefine>

	PerlPassEnv AWS_CONTAINER_CREDENTIALS_RELATIVE_URI
	PerlPassEnv AWS_DEFAULT_REGION
	PerlPassEnv E2_DOCKER
	PerlPassEnv E2_MAINTENANCE_MESSAGE
	PerlPassEnv E2_DBSERV

	# Apache::DBI MUST be loaded before DBI to intercept connections
	# Configure ping timeout to avoid unnecessary connection checks
	PerlModule Apache::DBI
	<Perl>
		# Set ping timeout - only ping if connection idle > 60 seconds
		# Reduces overhead on every request while catching stale connections
		Apache::DBI->setPingTimeOut("DBI:mysql", 60);
	</Perl>

	# Preload modules to maximize shared memory via copy-on-write
	# Heavy modules loaded before fork are shared across all workers
	# Core Perl/Apache modules
	PerlModule Apache2::compat DBI DBD::mysql CGI CGI::Carp
	# Object system and utilities
	PerlModule Moose namespace::autoclean Clone Try::Tiny
	# Date/Time handling
	PerlModule DateTime DateTime::Format::Strptime Date::Calc Time::Local
	# JSON (load XS versions for speed)
	PerlModule JSON JSON::XS Cpanel::JSON::XS JSON::MaybeXS
	# HTTP/Network
	PerlModule LWP::UserAgent HTTP::Request HTTP::Cookies URI
	# HTML processing
	PerlModule HTML::Scrubber HTML::Defang
	# Compression
	PerlModule Compress::Zlib IO::Compress::Brotli IO::Compress::Deflate IO::Compress::Zstd
	# XML
	PerlModule XML::Generator XML::Parser XML::Simple
	# Crypto/Encoding
	PerlModule Digest::MD5 Digest::SHA Encode
	# AWS (heavy - loads many sub-modules)
	PerlModule Paws Ref::Util::XS
	# Mason templating
	PerlModule Mason Mason::Plugin::HTMLFilters
	# Utility modules
	PerlModule Data::Dumper Carp Devel::Caller Test::Deep::NoTest Module::Pluggable File::Copy
	# E2 core modules
	PerlModule Everything Everything::HTML Everything::Application Everything::Request
	PerlResponseHandler ModPerl::Registry
	PerlOptions +ParseHeaders

	# Serve favicon.ico from static directory
	Alias /favicon.ico /var/everything/www/static/favicon.ico
	<Location /favicon.ico>
		Require all granted
		SetEnv dontlog 1
	</Location>

	# Static files directory
	<Directory /var/everything/www/static/>
		Require all granted
		Options -ExecCGI
	</Directory>

	# Health check endpoint - no access logging
	<Location /health.pl>
		SetEnv dontlog 1
	</Location>

	# Apache server-status for monitoring (localhost only)
	<Location /server-status>
		SetHandler server-status
		Require local
		SetEnv dontlog 1
	</Location>

<%= ip_blocks %>

	<Directory /var/everything/www/>
		DirectoryIndex index.pl
		AddHandler perl-script .pl
		Options +ExecCGI +FollowSymLinks
		AllowOverride None
		Order allow,deny
		allow from all
		deny from env=denyip

		RewriteEngine On

		# Health check endpoint - lightweight Perl check for ALB/ECS
		RewriteRule ^health$ /health.pl [L,QSA]

		RewriteRule ^favicon.ico$ /static/favicon.ico [L]

		RewriteRule ^node/(\d+)/(\w+)/?$           index.pl?node_id=$1&displaytype=$2  [L,QSA,BCTLS]
		RewriteRule ^node/(\d+)([^&]*)/?$          index.pl?node_id=$1$2                [L,QSA,BCTLS]
		RewriteRule ^e2node/(.+)                   /index.pl?node=$1                     [L,QSA,BCTLS]
		RewriteRule ^node/([^\d][^/]*)$            /index.pl?node=$1                    [L,QSA,BCTLS]

		RewriteRule ^node/([^\W\/]+)/([^&]+).*/?$  index.pl?node=$2&type=$1            [L,QSA,BCTLS]
		RewriteRule ^title/([^&]+).*/?$            index.pl?node=$1                    [L,QSA,BCTLS]

		RewriteRule ^user/([^&]+)/writeups/([^&]+).*/?$   index.pl?node=$2&type=writeup&author=$1      [L,QSA,BCTLS]
		RewriteRule ^user/([^&]+)/writeups/?$      index.pl?node=everything+user+search&type=superdoc&usersearch=$1&orderby=node.createtime+DESC   [L,QSA,BCTLS]
		RewriteRule ^user/([^&]+).*/?$             index.pl?node=$1&type=user          [L,QSA,BCTLS]

		# Short URL redirection
		RewriteRule ^/?s/([^/]+)$                  index.pl?type=superdoc&node=Short+URL+Lookup&short_string=$1

		RewriteCond %{REQUEST_FILENAME}            !-f
		RewriteRule ^/?stylesheet/([^_]+)_v[0-9]+(_autofix)?\.css      /stylesheet/$1$2.css  [R=307]

		RewriteRule ^/?sitemap/(.+)$               http://sitemap.everything2.com/$1 [P]
		RewriteRule ^/?sitemap.xml$                http://sitemap.everything2.com/index.xml [P]

		AddOutputFilterByType DEFLATE text/javascript text/html text/xml text/css application/x-javascript
	</Directory>

	ScriptAliasMatch /api/.* /var/everything/www/api/index.pl
	<Directory /var/everything/www/api/>
		DirectoryIndex index.pl
		AddHandler perl-script .pl
		Options +ExecCGI +FollowSymLinks
		AllowOverride None
		Order allow,deny
		allow from all
		deny from env=denyip
	</Directory>

	<IfDefine E2_DEVELOPMENT>
		ErrorLog "|<%= rotatelogs %> -f /var/log/apache2/e2.error.%Y%m%d%H.log 3600"
		CustomLog "|<%= rotatelogs %> -f /var/log/apache2/e2.access.%Y%m%d%H.log 3600" cloudwatch env=!dontlog
	</IfDefine>

	ServerSignature On
</VirtualHost>
