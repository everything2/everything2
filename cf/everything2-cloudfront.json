{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "E2 CloudFront distribution - must be deployed to us-east-1",
  "Parameters": {
    "ALBDomainName": {
      "Type": "String",
      "Description": "Domain name of the ALB origin (e.g., E2-Containerized-Frontend-ELB-123456.us-west-2.elb.amazonaws.com)",
      "AllowedPattern": "^[a-zA-Z0-9-]+\\.us-west-2\\.elb\\.amazonaws\\.com$"
    }
  },
  "Resources": {
    "E2BlockedScrapersIPSet": {
      "Type": "AWS::WAFv2::IPSet",
      "Properties": {
        "Name": "E2-Blocked-Scrapers",
        "Description": "Blocked scraper IP ranges - data center IPs with fake UAs doing burst scraping",
        "Scope": "CLOUDFRONT",
        "IPAddressVersion": "IPV4",
        "Addresses": [
          "47.79.0.0/16",
          "202.46.0.0/16"
        ]
      }
    },

    "E2CloudFrontLogsBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": "cloudfrontlogs.everything2.com",
        "OwnershipControls": {
          "Rules": [
            {
              "ObjectOwnership": "BucketOwnerPreferred"
            }
          ]
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": false,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": false,
          "RestrictPublicBuckets": true
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "DeleteOldLogs",
              "Status": "Enabled",
              "ExpirationInDays": 7
            }
          ]
        }
      }
    },

    "E2CloudFrontLogsBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "DependsOn": "E2CloudFrontLogsBucket",
      "Properties": {
        "Bucket": {"Ref": "E2CloudFrontLogsBucket"},
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "AllowCloudFrontLogDelivery",
              "Effect": "Allow",
              "Principal": {
                "Service": "delivery.logs.amazonaws.com"
              },
              "Action": "s3:PutObject",
              "Resource": {"Fn::Sub": "arn:aws:s3:::${E2CloudFrontLogsBucket}/*"},
              "Condition": {
                "StringEquals": {
                  "s3:x-amz-acl": "bucket-owner-full-control",
                  "aws:SourceAccount": {"Ref": "AWS::AccountId"}
                }
              }
            },
            {
              "Sid": "AllowCloudFrontLogDeliveryAclCheck",
              "Effect": "Allow",
              "Principal": {
                "Service": "delivery.logs.amazonaws.com"
              },
              "Action": "s3:GetBucketAcl",
              "Resource": {"Fn::Sub": "arn:aws:s3:::${E2CloudFrontLogsBucket}"},
              "Condition": {
                "StringEquals": {
                  "aws:SourceAccount": {"Ref": "AWS::AccountId"}
                }
              }
            }
          ]
        }
      }
    },

    "E2WAFWebACL": {
      "Type": "AWS::WAFv2::WebACL",
      "Properties": {
        "Name": "E2-CloudFront-WAF",
        "Description": "WAF WebACL for Everything2 CloudFront distribution",
        "Scope": "CLOUDFRONT",
        "DefaultAction": {
          "Allow": {}
        },
        "VisibilityConfig": {
          "SampledRequestsEnabled": true,
          "CloudWatchMetricsEnabled": true,
          "MetricName": "E2CloudFrontWAF"
        },
        "Rules": [
          {
            "Name": "BlockScraperIPs",
            "Priority": 0,
            "Action": {
              "Block": {}
            },
            "Statement": {
              "IPSetReferenceStatement": {
                "Arn": {"Fn::GetAtt": ["E2BlockedScrapersIPSet", "Arn"]}
              }
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "BlockScraperIPsMetric"
            }
          },
          {
            "Name": "AWS-AWSManagedRulesCommonRuleSet",
            "Priority": 1,
            "OverrideAction": {
              "None": {}
            },
            "Statement": {
              "ManagedRuleGroupStatement": {
                "VendorName": "AWS",
                "Name": "AWSManagedRulesCommonRuleSet",
                "ScopeDownStatement": {
                  "NotStatement": {
                    "Statement": {
                      "ByteMatchStatement": {
                        "SearchString": "/api/sessions",
                        "FieldToMatch": {
                          "UriPath": {}
                        },
                        "TextTransformations": [
                          {
                            "Priority": 0,
                            "Type": "LOWERCASE"
                          }
                        ],
                        "PositionalConstraint": "STARTS_WITH"
                      }
                    }
                  }
                }
              }
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "AWSManagedRulesCommonRuleSetMetric"
            }
          },
          {
            "Name": "AWS-AWSManagedRulesKnownBadInputsRuleSet",
            "Priority": 2,
            "OverrideAction": {
              "None": {}
            },
            "Statement": {
              "ManagedRuleGroupStatement": {
                "VendorName": "AWS",
                "Name": "AWSManagedRulesKnownBadInputsRuleSet"
              }
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "AWSManagedRulesKnownBadInputsRuleSetMetric"
            }
          },
          {
            "Name": "AWS-AWSManagedRulesBotControlRuleSet",
            "Priority": 3,
            "OverrideAction": {
              "Count": {}
            },
            "Statement": {
              "ManagedRuleGroupStatement": {
                "VendorName": "AWS",
                "Name": "AWSManagedRulesBotControlRuleSet",
                "ManagedRuleGroupConfigs": [
                  {
                    "AWSManagedRulesBotControlRuleSet": {
                      "InspectionLevel": "COMMON"
                    }
                  }
                ],
                "ScopeDownStatement": {
                  "NotStatement": {
                    "Statement": {
                      "ByteMatchStatement": {
                        "SearchString": "/api/sessions",
                        "FieldToMatch": {
                          "UriPath": {}
                        },
                        "TextTransformations": [
                          {
                            "Priority": 0,
                            "Type": "LOWERCASE"
                          }
                        ],
                        "PositionalConstraint": "STARTS_WITH"
                      }
                    }
                  }
                }
              }
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "AWSManagedRulesBotControlRuleSetMetric"
            }
          },
          {
            "Name": "AllowCrawlerEssentials",
            "Priority": 4,
            "Action": {
              "Allow": {}
            },
            "Statement": {
              "OrStatement": {
                "Statements": [
                  {
                    "ByteMatchStatement": {
                      "SearchString": "/robots.txt",
                      "FieldToMatch": {
                        "UriPath": {}
                      },
                      "TextTransformations": [
                        {
                          "Priority": 0,
                          "Type": "LOWERCASE"
                        }
                      ],
                      "PositionalConstraint": "EXACTLY"
                    }
                  },
                  {
                    "ByteMatchStatement": {
                      "SearchString": "/sitemap",
                      "FieldToMatch": {
                        "UriPath": {}
                      },
                      "TextTransformations": [
                        {
                          "Priority": 0,
                          "Type": "LOWERCASE"
                        }
                      ],
                      "PositionalConstraint": "STARTS_WITH"
                    }
                  }
                ]
              }
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "AllowCrawlerEssentialsMetric"
            }
          },
          {
            "Name": "RateLimitRule",
            "Priority": 5,
            "Action": {
              "Block": {}
            },
            "Statement": {
              "RateBasedStatement": {
                "Limit": 400,
                "AggregateKeyType": "IP"
              }
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "RateLimitRuleMetric"
            }
          },
          {
            "Name": "BlockBadUserAgents",
            "Priority": 6,
            "Action": {
              "Block": {}
            },
            "Statement": {
              "OrStatement": {
                "Statements": [
                  {
                    "ByteMatchStatement": {
                      "SearchString": "aiohttp",
                      "FieldToMatch": {
                        "SingleHeader": {
                          "Name": "user-agent"
                        }
                      },
                      "TextTransformations": [
                        {
                          "Priority": 0,
                          "Type": "LOWERCASE"
                        }
                      ],
                      "PositionalConstraint": "CONTAINS"
                    }
                  },
                  {
                    "ByteMatchStatement": {
                      "SearchString": "blexbot",
                      "FieldToMatch": {
                        "SingleHeader": {
                          "Name": "user-agent"
                        }
                      },
                      "TextTransformations": [
                        {
                          "Priority": 0,
                          "Type": "LOWERCASE"
                        }
                      ],
                      "PositionalConstraint": "CONTAINS"
                    }
                  },
                  {
                    "ByteMatchStatement": {
                      "SearchString": "dataforseobot",
                      "FieldToMatch": {
                        "SingleHeader": {
                          "Name": "user-agent"
                        }
                      },
                      "TextTransformations": [
                        {
                          "Priority": 0,
                          "Type": "LOWERCASE"
                        }
                      ],
                      "PositionalConstraint": "CONTAINS"
                    }
                  },
                  {
                    "ByteMatchStatement": {
                      "SearchString": "httrack",
                      "FieldToMatch": {
                        "SingleHeader": {
                          "Name": "user-agent"
                        }
                      },
                      "TextTransformations": [
                        {
                          "Priority": 0,
                          "Type": "LOWERCASE"
                        }
                      ],
                      "PositionalConstraint": "CONTAINS"
                    }
                  }
                ]
              }
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "BlockBadUserAgentsMetric"
            }
          }
        ]
      }
    },

    "E2CloudFrontCertificate": {
      "Type": "AWS::CertificateManager::Certificate",
      "DeletionPolicy": "Retain",
      "Properties": {
        "DomainName": "everything2.com",
        "ValidationMethod": "DNS",
        "SubjectAlternativeNames": [
          "*.everything2.com",
          "everything2.net",
          "*.everything2.net",
          "everything2.org",
          "*.everything2.org"
        ]
      }
    },

    "E2PageCachePolicy": {
      "Type": "AWS::CloudFront::CachePolicy",
      "Properties": {
        "CachePolicyConfig": {
          "Name": "E2-Page-Cache-Policy",
          "Comment": "Cache pages - origin controls caching via Cache-Control headers",
          "DefaultTTL": 300,
          "MaxTTL": 3600,
          "MinTTL": 0,
          "ParametersInCacheKeyAndForwardedToOrigin": {
            "CookiesConfig": {
              "CookieBehavior": "whitelist",
              "Cookies": [
                "userpass"
              ]
            },
            "HeadersConfig": {
              "HeaderBehavior": "none"
            },
            "QueryStringsConfig": {
              "QueryStringBehavior": "whitelist",
              "QueryStrings": [
                "node_id",
                "node",
                "displaytype",
                "type",
                "searchtype",
                "keywords",
                "page",
                "offset",
                "limit"
              ]
            },
            "EnableAcceptEncodingGzip": true,
            "EnableAcceptEncodingBrotli": true
          }
        }
      }
    },


    "E2OriginRequestPolicy": {
      "Type": "AWS::CloudFront::OriginRequestPolicy",
      "Properties": {
        "OriginRequestPolicyConfig": {
          "Name": "E2-Origin-Request-Policy",
          "Comment": "Forward all necessary headers/cookies to origin",
          "CookiesConfig": {
            "CookieBehavior": "all"
          },
          "HeadersConfig": {
            "HeaderBehavior": "whitelist",
            "Headers": [
              "Host",
              "Accept",
              "Accept-Language",
              "Referer",
              "User-Agent",
              "CloudFront-Viewer-Country",
              "CloudFront-Is-Mobile-Viewer",
              "CloudFront-Is-Tablet-Viewer",
              "CloudFront-Is-Desktop-Viewer",
              "X-Forwarded-For"
            ]
          },
          "QueryStringsConfig": {
            "QueryStringBehavior": "all"
          }
        }
      }
    },

    "E2CloudFrontMonitoringSubscription": {
      "Type": "AWS::CloudFront::MonitoringSubscription",
      "DependsOn": "E2CloudFrontDistribution",
      "Properties": {
        "DistributionId": {"Ref": "E2CloudFrontDistribution"},
        "MonitoringSubscription": {
          "RealtimeMetricsSubscriptionConfig": {
            "RealtimeMetricsSubscriptionStatus": "Enabled"
          }
        }
      }
    },

    "E2CloudFrontDistribution": {
      "Type": "AWS::CloudFront::Distribution",
      "DependsOn": ["E2CloudFrontCertificate", "E2WAFWebACL", "E2CloudFrontLogsBucketPolicy"],
      "Properties": {
        "DistributionConfig": {
          "WebACLId": {"Fn::GetAtt": ["E2WAFWebACL", "Arn"]},
          "Comment": "Everything2 CloudFront Distribution",
          "Enabled": true,
          "Logging": {
            "Bucket": {"Fn::GetAtt": ["E2CloudFrontLogsBucket", "DomainName"]},
            "IncludeCookies": false,
            "Prefix": "cf-logs/"
          },
          "HttpVersion": "http2and3",
          "IPV6Enabled": true,
          "PriceClass": "PriceClass_100",

          "Aliases": [
            "everything2.com",
            "www.everything2.com",
            "m.everything2.com",
            "everything2.net",
            "www.everything2.net",
            "everything2.org",
            "www.everything2.org"
          ],

          "ViewerCertificate": {
            "AcmCertificateArn": {"Ref": "E2CloudFrontCertificate"},
            "SslSupportMethod": "sni-only",
            "MinimumProtocolVersion": "TLSv1.2_2021"
          },

          "Origins": [
            {
              "Id": "E2-ALB-Origin",
              "DomainName": {"Ref": "ALBDomainName"},
              "CustomOriginConfig": {
                "HTTPPort": 80,
                "HTTPSPort": 443,
                "OriginProtocolPolicy": "https-only",
                "OriginSSLProtocols": ["TLSv1.2"],
                "OriginReadTimeout": 60,
                "OriginKeepaliveTimeout": 5
              },
              "OriginCustomHeaders": [
                {
                  "HeaderName": "X-Origin-Verify",
                  "HeaderValue": "e2-cloudfront-origin-2025"
                }
              ]
            }
          ],

          "DefaultCacheBehavior": {
            "TargetOriginId": "E2-ALB-Origin",
            "ViewerProtocolPolicy": "redirect-to-https",
            "AllowedMethods": ["GET", "HEAD", "OPTIONS", "PUT", "POST", "PATCH", "DELETE"],
            "CachedMethods": ["GET", "HEAD", "OPTIONS"],
            "Compress": true,
            "CachePolicyId": {"Ref": "E2PageCachePolicy"},
            "OriginRequestPolicyId": {"Ref": "E2OriginRequestPolicy"}
          },

          "CacheBehaviors": [
            {
              "PathPattern": "/api/*",
              "TargetOriginId": "E2-ALB-Origin",
              "ViewerProtocolPolicy": "redirect-to-https",
              "AllowedMethods": ["GET", "HEAD", "OPTIONS", "PUT", "POST", "PATCH", "DELETE"],
              "CachedMethods": ["GET", "HEAD"],
              "Compress": true,
              "CachePolicyId": "4135ea2d-6df8-44a3-9df3-4b5a84be39ad",
              "OriginRequestPolicyId": "216adef6-5c7f-47e4-b989-5492eafa07d3"
            },
            {
              "PathPattern": "/op/*",
              "TargetOriginId": "E2-ALB-Origin",
              "ViewerProtocolPolicy": "redirect-to-https",
              "AllowedMethods": ["GET", "HEAD", "OPTIONS", "PUT", "POST", "PATCH", "DELETE"],
              "CachedMethods": ["GET", "HEAD"],
              "Compress": true,
              "CachePolicyId": "4135ea2d-6df8-44a3-9df3-4b5a84be39ad",
              "OriginRequestPolicyId": "216adef6-5c7f-47e4-b989-5492eafa07d3"
            }
          ],

          "CustomErrorResponses": [
            {
              "ErrorCode": 503,
              "ErrorCachingMinTTL": 0
            },
            {
              "ErrorCode": 502,
              "ErrorCachingMinTTL": 0
            },
            {
              "ErrorCode": 504,
              "ErrorCachingMinTTL": 0
            }
          ]
        }
      }
    }
  },

  "Outputs": {
    "CloudFrontDomainName": {
      "Description": "CloudFront distribution domain name - update Route53 to point here",
      "Value": {"Fn::GetAtt": ["E2CloudFrontDistribution", "DomainName"]}
    },
    "CloudFrontDistributionId": {
      "Description": "CloudFront distribution ID",
      "Value": {"Ref": "E2CloudFrontDistribution"}
    },
    "CertificateArn": {
      "Description": "ACM Certificate ARN (must be validated via DNS)",
      "Value": {"Ref": "E2CloudFrontCertificate"}
    },
    "WAFWebACLArn": {
      "Description": "WAF WebACL ARN",
      "Value": {"Fn::GetAtt": ["E2WAFWebACL", "Arn"]}
    }
  }
}
